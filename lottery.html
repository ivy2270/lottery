<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>2025é™½æ˜ç‰™é†«è¯åˆå°¾ç‰™</title>
<link rel="icon" type="image/svg+xml" href="red-envelope-svgrepo-com.svg">
<style>
@font-face {
  font-family: 'jf-openhuninn';
  src: url('https://ymdd-image-tw.s3.ap-east-2.amazonaws.com/font/jf-openhuninn-2.1.ttf') format('truetype');
}

:root { 
  --pink1:#FFE4EC; --pink2:#FF9BB3; --accent:#FF4D84; --gold: #f1c40f;
}

body { 
  font-family: 'jf-openhuninn', "Noto Sans TC", sans-serif; 
  background: linear-gradient(180deg, var(--pink1), #fff); 
  margin: 0; padding: 10px; min-height: 100vh; box-sizing: border-box; 
  overflow-x: hidden;
}

.container { 
  max-width: 1400px; margin: 0 auto; background: rgba(255,255,255,0.96); 
  border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.12); padding: 20px; 
}

.row { display: flex; gap: 30px; flex-wrap: wrap; }

/* --- å·¦å´æ§åˆ¶é¢æ¿ --- */
.control { 
  flex: 0 0 320px; max-width: 100%; background: #fffafa; padding: 25px;
  border-radius: 15px; border: 1px solid var(--pink1); box-sizing: border-box;
}
.control h2 { color: var(--accent); font-size: 1.6rem; text-align: center; margin: 0 0 20px 0; padding-bottom: 10px; border-bottom: 2px solid var(--pink2); }
.control-group { margin-bottom: 25px; }
.control label { display: block; font-weight: 800; margin-bottom: 10px; color: #333; font-size: 1.1rem; }
.control input[type="text"], .control input[type="number"] { padding: 15px; border-radius: 12px; border: 2px solid var(--pink1); width: 100%; box-sizing: border-box; font-family: inherit; font-size: 1.1rem; }

.checkbox-group { display: flex; flex-direction: column; gap: 15px; margin-bottom: 25px; }
.checkbox-row { display: flex; align-items: center; font-weight: bold; font-size: 1.1rem; cursor: pointer; color: #444; }
.checkbox-row input[type="checkbox"] { width: 24px; height: 24px; margin: 0 12px 0 0; cursor: pointer; accent-color: var(--accent); }

#drawBtn { width: 100%; background: var(--accent); color: white; border: none; padding: 18px; border-radius: 12px; font-weight: 900; font-size: 1.5rem; cursor: pointer; box-shadow: 0 6px 0 #d43265; transition: all 0.1s; }
#drawBtn:active { transform: translateY(4px); box-shadow: 0 2px 0 #d43265; }
#refreshBtn { width:100%; margin-top:15px; background:none; border:1px solid #ccc; color:#666; padding:10px; border-radius:10px; cursor:pointer; font-weight:bold; }

.current-winners-box { margin-top: 25px; padding: 15px; background: white; border: 2px dashed var(--pink2); border-radius: 12px; }

/* --- å³å´è¦–è¦ºå€ --- */
.visual { flex: 1; min-width: 0; text-align: center; }
#cardsArea { min-height: 350px; display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 15px; margin: 20px 0; }

.card { width: clamp(100px, 15vw, 180px); height: clamp(140px, 22vw, 250px); perspective: 1000px; display: inline-flex; flex-shrink: 0; }
.card-inner { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
.card.flipped .card-inner { transform: rotateY(180deg); }
.card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 15px rgba(0,0,0,0.1); border: 3px solid #fff; }
.card-front { background: var(--pink2); color: #fff; font-size: 3rem; }
.card-back { background: var(--accent); color: #fff; transform: rotateY(180deg); padding: 10px; text-align: center; white-space: pre-wrap; font-size: clamp(0.9rem, 1.5vw, 1.4rem); border: 3px solid var(--gold); word-break: break-all; overflow: hidden; }

#resultArea { font-size: 2rem; font-weight: 800; color: var(--accent); min-height: 60px; margin-bottom: 15px; }

/* --- æ­·å²ç´€éŒ„èˆ‡é ˜çç‹€æ…‹æ¨£å¼ --- */
.history-section { margin-top: 50px; border-top: 6px double var(--pink2); padding-top: 25px; }
.history-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; justify-content: center; }
.prize-group-card { background: white; border: 2px solid var(--pink2); border-radius: 15px; padding: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); max-width: 320px; }
.prize-title { font-size: 1.4rem; color: #b72b4b; font-weight: 900; border-bottom: 2px solid var(--pink1); margin-bottom: 12px; text-align: center; }

.history-item { 
  display: flex; justify-content: space-between; align-items: center; 
  padding: 10px 0; border-bottom: 1px dashed #eee; font-size: 1.1rem;
  transition: all 0.3s ease; 
}
.history-item span { flex: 1; text-align: left; padding-right: 10px; color: #444; }

.history-item.claimed span {
  opacity: 0.4;
  text-decoration: line-through;
  color: #888;
}
.claim-box { width: 22px; height: 22px; flex-shrink: 0; cursor: pointer; accent-color: #4CAF50; }

@media (max-width: 850px) {
  .row { flex-direction: column; }
  .control { border-right: none; flex: 1; width: 100%; }
  .card { width: 90px; height: 130px; }
  .history-grid { grid-template-columns: 1fr; }
  .prize-group-card { max-width: 100%; }
}
</style>
</head>
<body>

<div class="container">
  <div class="row">
    <div class="control">
      <h2>âš™ï¸ æŠ½çæ§åˆ¶</h2>
      <div class="control-group"><label>ğŸ† è¨­å®šç›®å‰çé …</label><input id="prize" type="text" placeholder="ä¾‹å¦‚ï¼šé ­ç 10è¬"></div>
      <div class="control-group"><label>ğŸ‘¥ æŠ½å‡ºäººæ•¸</label><input id="count" type="number" min="1" value="1"></div>
      <div class="checkbox-group">
        <label class="checkbox-row"><input id="allowRepeat" type="checkbox"><span>å…è¨±é‡è¤‡ä¸­ç</span></label>
        <label class="checkbox-row"><input id="twoStepReveal" type="checkbox"><span>å•Ÿç”¨å…©æ®µå¼æ­æ›‰</span></label>
      </div>
      <button id="drawBtn">ğŸ”¥ é–‹å§‹æŠ½ç</button>
      <button id="refreshBtn">ğŸ”„ åŒæ­¥ä¸­çç´€éŒ„</button>
      <div id="status" style="margin-top:15px; font-weight:bold; color:var(--accent); text-align:center;"></div>
      <div id="countdown" style="text-align:center; color:#999; font-size:0.9rem; margin-top:5px;"></div>
      <div class="current-winners-box">
        <h3 style="margin:0 0 10px 0; font-size:1rem; color:#b72b4b; border-bottom:1px solid #eee; padding-bottom:5px;">ğŸ¯ æœ¬æ¬¡ä¸­çå¿«å ±</h3>
        <div id="currentWinners" style="font-size:1rem; line-height:1.6; color:#333;">å°šæœªæŠ½ç</div>
      </div>
    </div>

    <div class="visual">
      <h1 style="color: #b72b4b; margin: 0 0 20px 0;">ğŸ§§ 2025é™½æ˜ç‰™é†«è¯åˆå°¾ç‰™ ğŸ§§</h1>
      <div id="cardsArea"></div>
      <div id="resultArea"></div>
      <button id="revealNumberBtn" style="background:#5aa9e6; color:white; border:none; padding:18px 50px; border-radius:50px; font-size:1.8rem; font-weight:bold; cursor:pointer; display:none; margin:15px auto; box-shadow: 0 8px 25px rgba(90,169,230,0.4);">âœ¨ æ­æ›‰å¹¸é‹å…’ âœ¨</button>
      <div class="history-section">
        <h2 style="color:var(--accent); text-align:left; font-size:1.8rem; margin-bottom:20px;">ğŸ“‹ ä¸­çç´€éŒ„</h2>
        <div id="historyArea" class="history-grid">è¼‰å…¥ä¸­â€¦</div>
      </div>
    </div>
  </div>
</div>

<script>
// ====== JavaScript é‚è¼¯ ======
const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwLJfHH_GFF790oDbJH-w4vkazm8iNCOM7nlFYklysjj8FcV0V8NCAHu85a6OsFHrwL/exec'; 

const drawBtn = document.getElementById('drawBtn');
const refreshBtn = document.getElementById('refreshBtn');
const prizeInput = document.getElementById('prize');
const countInput = document.getElementById('count');
const allowRepeatInput = document.getElementById('allowRepeat');
const statusDiv = document.getElementById('status');
const cardsArea = document.getElementById('cardsArea');
const resultArea = document.getElementById('resultArea');
const currentWinnersDiv = document.getElementById('currentWinners');
const historyArea = document.getElementById('historyArea');
const countdownEl = document.getElementById('countdown');
const twoStepRevealInput = document.getElementById('twoStepReveal');
const revealNumberBtn = document.getElementById('revealNumberBtn');

let currentWinnersData = []; 
let lockTimer = null;

async function callGAS(action, data = null) {
  try {
    const response = await fetch(GAS_WEB_APP_URL, {
      method: 'POST',
      body: JSON.stringify({ action, data })
    });
    return await response.json();
  } catch (err) {
    return { success: false, message: "ç¶²è·¯é€£ç·šå¤±æ•—" };
  }
}

function createCard() {
  const wrapper = document.createElement('div');
  wrapper.className = 'card';
  const inner = document.createElement('div');
  inner.className = 'card-inner';
  const front = document.createElement('div');
  front.className = 'card-face card-front';
  front.textContent = 'ğŸ´';
  const back = document.createElement('div');
  back.className = 'card-face card-back';
  inner.appendChild(front);
  inner.appendChild(back);
  wrapper.appendChild(inner);
  return { wrapper, inner, back };
}

async function loadHistory() {
  historyArea.textContent = 'è®€å–ä¸­â€¦';
  const res = await callGAS('list');
  if (!res.success) {
    historyArea.textContent = res.message || 'è¼‰å…¥å¤±æ•—';
    return;
  }
  const grouped = res.grouped || {};
  const prizeOrder = res.prizeOrder || []; 
  if (prizeOrder.length === 0) { 
    historyArea.textContent = 'ç›®å‰å°šç„¡ä¸­çç´€éŒ„';
    return;
  }
  historyArea.innerHTML = '';
  prizeOrder.forEach(prize => {
    const box = document.createElement('div');
    box.className = 'prize-group-card'; 
    const title = document.createElement('div');
    title.className = 'prize-title';
    title.textContent = prize;
    box.appendChild(title);

    // --- é—œéµæ’åºé‚è¼¯ï¼šé‡å°åŒä¸€çé …å…§çš„å¾—çè€…ä¾ã€Œæ¡Œè™Ÿã€åŠã€Œç·¨è™Ÿã€æ’åº ---
    const sortedItems = [...grouped[prize]].sort((a, b) => {
      if (parseInt(a.table) !== parseInt(b.table)) {
        return parseInt(a.table) - parseInt(b.table);
      }
      return parseInt(a.number) - parseInt(b.number);
    });

    sortedItems.forEach(item => {
      const p = document.createElement('div');
      p.className = 'history-item' + (item.isClaimed ? ' claimed' : '');
      
      const txt = document.createElement('span');
      txt.textContent = `${item.table}æ¡Œ-${item.number} ${item.name}`;
      
      const chk = document.createElement('input');
      chk.type = 'checkbox';
      chk.className = 'claim-box';
      chk.checked = item.isClaimed;
      chk.onchange = async () => {
        chk.disabled = true;
        if (chk.checked) p.classList.add('claimed');
        else p.classList.remove('claimed');

        const upRes = await callGAS('updateClaimStatus', { time: item.time, name: item.name, isClaimed: chk.checked });
        if(!upRes.success) { 
          alert('æ›´æ–°å¤±æ•—'); 
          chk.checked = !chk.checked; 
          p.classList.toggle('claimed');
        }
        chk.disabled = false;
      };
      
      p.appendChild(txt);
      p.appendChild(chk);
      box.appendChild(p);
    });
    historyArea.appendChild(box);
  });
}

drawBtn.addEventListener('click', async () => {
  const prize = prizeInput.value.trim();
  const count = parseInt(countInput.value, 10) || 1;
  const allowRepeat = !!allowRepeatInput.checked;
  const twoStep = !!twoStepRevealInput.checked; 
  if (!prize) { alert('è«‹è¼¸å…¥çé …åç¨±'); return; }
  if (count <= 0) { alert('è«‹è¼¸å…¥äººæ•¸'); return; }
  cardsArea.innerHTML = '';
  resultArea.innerHTML = '';
  currentWinnersDiv.textContent = 'æŠ½çä¸­...';
  statusDiv.textContent = `æ­£åœ¨æŠ½ ${prize}...`;
  drawBtn.disabled = true;
  refreshBtn.disabled = true;
  revealNumberBtn.style.display = 'none';

  const res = await callGAS('draw', { prize, count, allowRepeat });
  if (!res || !res.success) {
    statusDiv.textContent = 'æŠ½çå¤±æ•—';
    unlockWithCountdown(3);
    return;
  }

  const winners = res.winners || [];
  currentWinnersData = winners;
  statusDiv.textContent = res.message;
  currentWinnersDiv.innerHTML = '';
  
  const cards = [];
  winners.forEach((w, idx) => {
    const { wrapper, inner, back } = createCard();
    cardsArea.appendChild(wrapper);
    cards.push({ wrapper, inner, back });
    const line = document.createElement('div');
    line.textContent = twoStep ? `ç¬¬${w.table}æ¡Œ` : `ç¬¬${w.table}æ¡Œ-${w.number} ${w.name}`;
    line.className = 'current-winner-line-' + idx;
    currentWinnersDiv.appendChild(line);
  });

  winners.forEach((w, idx) => {
    const card = cards[idx];
    setTimeout(() => {
      card.wrapper.classList.add('flipped');
      card.back.textContent = twoStep ? `ç¬¬${w.table}æ¡Œ` : `${w.name}\n(${w.table}-${w.number})`; 
      const p = document.createElement('div');
      p.className = 'result-line-' + idx;
      p.style.color = 'var(--accent)';
      p.style.fontWeight = 'bold';
      p.textContent = twoStep ? `ç¬¬${w.table}æ¡Œ` : `${w.table}-${w.number} ${w.name}`;
      resultArea.appendChild(p);
    }, 500 + idx * 700);
  });

  if (twoStep && winners.length > 0) {
    setTimeout(() => { revealNumberBtn.style.display = 'block'; }, 600 + winners.length * 700);
  } else {
    setTimeout(() => { loadHistory(); unlockWithCountdown(3); }, 600 + winners.length * 700);
  }
});

revealNumberBtn.addEventListener('click', () => {
  if (currentWinnersData.length === 0) return;
  revealNumberBtn.disabled = true;
  currentWinnersData.forEach((w, idx) => {
    setTimeout(() => {
      const cardBack = document.querySelectorAll('.card-back')[idx];
      if (cardBack) cardBack.textContent = `${w.name}\n(${w.table}-${w.number})`; 
      const resLine = document.querySelector('.result-line-' + idx);
      if (resLine) resLine.textContent = `${w.table}-${w.number} ${w.name}`;
      const curLine = document.querySelector('.current-winner-line-' + idx);
      if (curLine) curLine.textContent = `ç¬¬${w.table}æ¡Œ-${w.number} ${w.name}`;
    }, idx * 500);
  });
  setTimeout(() => {
    revealNumberBtn.style.display = 'none';
    revealNumberBtn.disabled = false;
    loadHistory(); 
    unlockWithCountdown(3); 
  }, currentWinnersData.length * 500 + 800);
});

refreshBtn.addEventListener('click', () => {
  refreshBtn.disabled = true;
  loadHistory();
  setTimeout(()=> refreshBtn.disabled = false, 1000);
});

function unlockWithCountdown(sec) {
  let t = sec;
  countdownEl.style.display = 'inline-block';
  countdownEl.textContent = `(å†·å» ${t}s)`;
  if (lockTimer) clearInterval(lockTimer); 
  lockTimer = setInterval(() => {
    t--;
    if (t <= 0) {
      clearInterval(lockTimer);
      countdownEl.style.display = 'none';
      drawBtn.disabled = false;
      refreshBtn.disabled = false;
    } else {
      countdownEl.textContent = `(å†·å» ${t}s)`;
    }
  }, 1000);
}

loadHistory();
</script>
</body>
</html>
